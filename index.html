<!DOCTYPE html>

<html lang="en">

<head>
    <title>Heart of Molvan√Æa</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
	<meta name="msapplication-TileColor" content="#da532c">
	<meta name="theme-color" content="#ffffff">
	<style>
document, body {
	padding: 0px;
	margin: 0px;
	overflow: hidden;
	background-color: black;
	font: 16px Arial, sans-serif;
}
*:focus {
	outline: none;
}
a:link, a:visited, a:hover, a:active {
  color: gray;
}
#btn {
  background-color: #4CAF50; /* Green */
  border: none;
  color: white;
  padding: 15px 32px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 16px;
  border-radius: 8px;
  cursor: pointer;
  margin-bottom: 12px;
}
#btn:disabled {
  background-color: grey;
  opacity: 0.6;
  cursor: not-allowed;
}
#starter_menu {
	color: white;
	text-align: center;
	position: absolute;
	top: 0px;
	left: 0px;
	margin-top: 5em;
	width: 100%;
}
#timer {
	position: absolute;
	top: 0px;
	color:white;
	left: 0px;
}
.recipe {
	position: absolute;
	color: white;
	bottom: 5%;
	right: 3%;
	width: 10%;
	margin: auto;
	display: none;
}
@keyframes fadein {
    from { opacity: 0; }
    to   { opacity: 1; }
}
@keyframes fadeout {
    from { opacity: 1; }
    to   { opacity: 0; }
}
.visible {
  visibility: visible;
  opacity: 1;
  transition: opacity 2s linear;
}
.hidden {
  visibility: hidden;
  opacity: 0;
  transition: visibility 0s 2s, opacity 2s linear;
}

	</style>
</head>

<body>
    <script id="vs" type="x-shader/x-vertex">
        #version 300 es
        #define POSITION_LOCATION 0
        #define TEXCOORD_LOCATION 4

        precision highp float;
        precision highp int;

        uniform mat4 MVP;

        layout(location = POSITION_LOCATION) in vec2 position;
        layout(location = TEXCOORD_LOCATION) in vec2 texcoord;

        out vec2 v_st;

        void main() {
            v_st = texcoord;
            gl_Position = MVP * vec4(position, 0.0, 1.0);
        }
    </script>

    <script src="utility.js"></script>
    <script src="utility2.js"></script>

    <script>
  
		// debug vars
 		let sync_stuff = true;
 		let skip = false;
		let skip_timer = 0;
		
		var is_chrome = navigator.userAgent.indexOf('Chrome') > -1;
		//var is_explorer = navigator.userAgent.indexOf('MSIE') > -1;
		//var is_firefox = navigator.userAgent.indexOf('Firefox') > -1;
		var is_safari = navigator.userAgent.indexOf("Safari") > -1;
		//var is_opera = navigator.userAgent.indexOf("Presto") > -1;
		if ((is_chrome)&&(is_safari)) {is_safari=false;}

		let init_time = 0;
		let loop = undefined;
		let showing_bullgif = false;

		var textures = [];
		var shaders = [];
		var res_count = 0;

		function checkLoad() {
			res_count++;
			//console.log('res_count: ' + res_count + ' ' + (textures.length+shaders.length));
			if (res_count == textures.length + shaders.length) {

				// init program
				shaderProgramQuad = initShaderProgramQuad(shaders[0]);
				
				// let user start the demo
				let button = shaderProgramQuad ? document.getElementById('btn') : null;
				if (button) {
					button.value = 'Start Demo!';
					button.disabled = false;
				}
			}
		}

		document.body.onload = function() {
			textures[0] = loadImage('gfx/metal_ox.png', function(ti){ console.log(ti); checkLoad(); });
			textures[1] = loadImage('gfx/tpolm_2d_array_test.png', function(ti){ console.log(ti); checkLoad(); });
			textures[2] = loadImage('gfx/pancake_1.png', function(ti){ console.log(ti); checkLoad(); });
			shaders[0] = loadShader('frag.glsl', function(src){ shaders[0]=src; checkLoad(); })
		}
				
		function start() {
		
			initAudio( function(){

						let dom = document.getElementById('starter_menu');
						if (dom) {
							dom.style.display = "none";
						}
						
						init_time = (new Date()).getTime() - skip_timer;
						backgroundAudio.start(0, skip_timer/1000);
						drawCanvas();
						
					});
		}

		let playtime = 2*60*1000+13724;

		window.onresize = resize;

		function resize() {
			w = window.innerWidth;
			h = window.innerHeight;
			c.setAttribute("width", w);
			c.setAttribute("height", h);
			if (gl!= undefined) gl.viewport(0, 0, w, h);
		}
		
		let program = undefined;
		let gl = undefined;
		let layerLocation = undefined;
		let timerLocation = undefined;
		let deltatimerLocation = undefined;
		
		// https://www.peko-step.com/en/tool/combine-images.html
		var NUM_IMAGES_0 = 6;
		var IMAGE_SIZE_0 = {
			width: 775,
			height: 775
		};
		
		var NUM_IMAGES_1 = 11;
		var IMAGE_SIZE_1 = {
			width: 640,
			height: 400
		};
		
		var NUM_IMAGES_2 = 5;
		var IMAGE_SIZE_2 = {
			width: 956,
			height: 631
		};
		
		function initShaderProgramQuad(fragSrc) {
			var canvas = document.getElementById('c');
			canvas.height = window.innerHeight;
			canvas.width = window.innerWidth;

			gl = canvas.getContext( 'webgl2', { antialias: false } );
			var isWebGL2 = !!gl;
			if (!isWebGL2) {
				document.getElementById('info').innerHTML = 'WebGL 2 is not available.  See <a href="https://www.khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">How to get a WebGL 2 implementation</a>';
				let button = document.getElementById('btn');
				button.value = 'Need WebGL 2 ü•∫';
				button.disabled = true;
				return;
			}
			
			resize();

			// -- Init program
			program = createProgram(gl, getShaderSource('vs'), fragSrc);

			var mvpLocation = gl.getUniformLocation(program, 'MVP');
			var t0Location = gl.getUniformLocation(program, 't0');
			var t1Location = gl.getUniformLocation(program, 't1');
			var t2Location = gl.getUniformLocation(program, 't2');
			layerLocation = gl.getUniformLocation(program, 'layer');
			timerLocation = gl.getUniformLocation(program, 'u_timer');
			deltatimerLocation = gl.getUniformLocation(program, 'u_delta_timer');


			// -- Init buffers
			var positions = new Float32Array([
				-1.0, -1.0,
				 1.0, -1.0,
				 1.0,  1.0,
				 1.0,  1.0,
				-1.0,  1.0,
				-1.0, -1.0
			]);
			var vertexPosBuffer = gl.createBuffer();
			gl.bindBuffer(gl.ARRAY_BUFFER, vertexPosBuffer);
			gl.bufferData(gl.ARRAY_BUFFER, positions, gl.STATIC_DRAW);
			gl.bindBuffer(gl.ARRAY_BUFFER, null);

			var texCoords = new Float32Array([
				0.0, 1.0,
				1.0, 1.0,
				1.0, 0.0,
				1.0, 0.0,
				0.0, 0.0,
				0.0, 1.0
			]);
			var vertexTexBuffer = gl.createBuffer();
			gl.bindBuffer(gl.ARRAY_BUFFER, vertexTexBuffer);
			gl.bufferData(gl.ARRAY_BUFFER, texCoords, gl.STATIC_DRAW);
			gl.bindBuffer(gl.ARRAY_BUFFER, null);

			// -- Init VertexArray
			var vertexArray = gl.createVertexArray();
			gl.bindVertexArray(vertexArray);

			var vertexPosLocation = 0; // set with GLSL layout qualifier
			gl.enableVertexAttribArray(vertexPosLocation);
			gl.bindBuffer(gl.ARRAY_BUFFER, vertexPosBuffer);
			gl.vertexAttribPointer(vertexPosLocation, 2, gl.FLOAT, false, 0, 0);
			gl.bindBuffer(gl.ARRAY_BUFFER, null);

			var vertexTexLocation = 4; // set with GLSL layout qualifier
			gl.enableVertexAttribArray(vertexTexLocation);
			gl.bindBuffer(gl.ARRAY_BUFFER, vertexTexBuffer);
			gl.vertexAttribPointer(vertexTexLocation, 2, gl.FLOAT, false, 0, 0);
			gl.bindBuffer(gl.ARRAY_BUFFER, null);

			gl.bindVertexArray(null);
			
			
			var texture0 = gl.createTexture();
			//loadImage('gfx/tpolm_2d_array_test.png', function(image){

			// use canvas to get the pixel data array of the image
			var canvas = document.createElement('canvas');
			canvas.width = IMAGE_SIZE_0.width;
			canvas.height = IMAGE_SIZE_0.height * NUM_IMAGES_0;
			var ctx = canvas.getContext('2d');
			ctx.drawImage(textures[0], 0, 0);
			var imageData = ctx.getImageData(0, 0, IMAGE_SIZE_0.width, IMAGE_SIZE_0.height * NUM_IMAGES_0);
			var pixels0 = new Uint8Array(imageData.data.buffer);
			
			// -- Init Texture
			gl.activeTexture(gl.TEXTURE0);
			gl.bindTexture(gl.TEXTURE_2D_ARRAY, texture0);
			gl.texParameteri(gl.TEXTURE_2D_ARRAY, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
			gl.texParameteri(gl.TEXTURE_2D_ARRAY, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
			gl.texImage3D(
				gl.TEXTURE_2D_ARRAY,
				0,
				gl.RGBA,
				IMAGE_SIZE_0.width,
				IMAGE_SIZE_0.height,
				NUM_IMAGES_0,
				0,
				gl.RGBA,
				gl.UNSIGNED_BYTE,
				pixels0
			);
			
			
			var texture1 = gl.createTexture();
				
			canvas = document.createElement('canvas');
			canvas.width = IMAGE_SIZE_1.width;
			canvas.height = IMAGE_SIZE_1.height * NUM_IMAGES_1;
			ctx = canvas.getContext('2d');
			ctx.drawImage(textures[1], 0, 0);
			var imageData1 = ctx.getImageData(0, 0, IMAGE_SIZE_1.width, IMAGE_SIZE_1.height * NUM_IMAGES_1);
			var pixels1 = new Uint8Array(imageData1.data.buffer);
			
			// -- Init Texture
			gl.activeTexture(gl.TEXTURE1);
			gl.bindTexture(gl.TEXTURE_2D_ARRAY, texture1);
			gl.texParameteri(gl.TEXTURE_2D_ARRAY, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
			gl.texParameteri(gl.TEXTURE_2D_ARRAY, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
			gl.texImage3D(
				gl.TEXTURE_2D_ARRAY,
				0,
				gl.RGBA,
				IMAGE_SIZE_1.width,
				IMAGE_SIZE_1.height,
				NUM_IMAGES_1,
				0,
				gl.RGBA,
				gl.UNSIGNED_BYTE,
				pixels1
			);
			
			
			var texture2 = gl.createTexture();
				
			canvas = document.createElement('canvas');
			canvas.width = IMAGE_SIZE_2.width;
			canvas.height = IMAGE_SIZE_2.height * NUM_IMAGES_2;
			ctx = canvas.getContext('2d');
			ctx.drawImage(textures[2], 0, 0);
			var imageData2 = ctx.getImageData(0, 0, IMAGE_SIZE_2.width, IMAGE_SIZE_2.height * NUM_IMAGES_2);
			var pixels2 = new Uint8Array(imageData2.data.buffer);
			
			// -- Init Texture
			gl.activeTexture(gl.TEXTURE2);
			gl.bindTexture(gl.TEXTURE_2D_ARRAY, texture2);
			gl.texParameteri(gl.TEXTURE_2D_ARRAY, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
			gl.texParameteri(gl.TEXTURE_2D_ARRAY, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
			gl.texImage3D(
				gl.TEXTURE_2D_ARRAY,
				0,
				gl.RGBA,
				IMAGE_SIZE_2.width,
				IMAGE_SIZE_2.height,
				NUM_IMAGES_2,
				0,
				gl.RGBA,
				gl.UNSIGNED_BYTE,
				pixels2
			);
			
			
			gl.useProgram(program);
			gl.bindVertexArray(vertexArray);
			
			var matrix = new Float32Array([
				1.0, 0.0, 0.0, 0.0,
				0.0, 1.0, 0.0, 0.0,
				0.0, 0.0, 1.0, 0.0,
				0.0, 0.0, 0.0, 1.0
			]);
			gl.uniformMatrix4fv(mvpLocation, false, matrix);
			gl.uniform1i(t0Location, 0);
			gl.uniform1i(t1Location, 1);
			gl.uniform1i(t2Location, 2);

			return program;
		}
        
		function drawCanvas() {

			let d = new Date();
			let n = d.getTime();
			let prevtime = n;
			
			(loop = function() {
				if (loop != undefined) {

					let timer, layer;
					if (skip == true) timer = skip_timer;
					 else timer = ((new Date()).getTime()-init_time);
					if (timer < playtime) {
						requestAnimationFrame( loop );
					} else {
						backToStartScreen();
					}
					
					if (sync_stuff == true) {
						let dom = document.getElementById('timer');
						if (dom) dom.innerText = timer;
						//console.log(timer);
					}
					
					layer = 0; //(timer*0.0005) % NUM_IMAGES_2;
					//console.log(layer);

					// -- Render
					gl.clearColor(1.0, 1.0, 1.0, 1.0);
					gl.clear(gl.COLOR_BUFFER_BIT);
					gl.uniform1i(layerLocation, layer);
					gl.uniform1f(timerLocation, timer);
					gl.uniform1f(deltatimerLocation, timer - prevtime);
					
					gl.drawArrays(gl.TRIANGLES, 0, 6);
				
					if ((timer > 31700) && (timer < 130000)) {
						if (showing_bullgif == false) 
						{
							var dom = document.getElementById('recipe1');
							if (dom) {
								dom.style.display = 'inline-block';
								dom.style.animation = 'fadein 4s';
								//dom.className = 'recipe visible';
							}
							//dom.addClass('fadein');
							showing_bullgif = true;
						}
					} else if (timer > 130000) {
						if (showing_bullgif == true) 
						{
							var dom = document.getElementById('recipe1');
							if (dom) {
								//dom.style.animation = 'fadeout 4s';
								dom.className = 'recipe hidden';
								showing_bullgif = false;
							}
						}
					}
					prevtime = ((new Date()).getTime());
				}
			})();
			
		}

		function backToStartScreen() {
			let dom = document.getElementById('starter_menu');
			if (dom) {
				dom.style.display = "block";
			}
			let dom2 = document.getElementById('btn');
			if (dom2) {
				dom2.value = 'Start Demo!';
				dom2.disabled = false;
			}
		}
		
        // If you have a long-running page, and need to delete WebGL resources, use:
        //
        // gl.deleteBuffer(vertexPosBuffer);
        // gl.deleteBuffer(vertexTexBuffer);
        // gl.deleteTexture(texture);
        // gl.deleteProgram(program);
        // gl.deleteVertexArray(vertexArray);


		var backgroundAudio = undefined;
		var analyser;
		var bufferLength;
		var dataArray;
						
		function initAudio( cb ) {
			var context;
			try {
				// Fix up for prefixing
				window.AudioContext = window.AudioContext||window.webkitAudioContext;
				if (backgroundAudio != undefined) backgroundAudio.stop();
				context = new AudioContext();

				var request = new XMLHttpRequest();	
				if (is_safari) request.open('GET', 'audio/15_mons_jacet_-_outro.m4a', true);
					else request.open('GET', 'audio/15_mons_jacet_-_outro.ogg', true);
				request.responseType = 'arraybuffer';
				console.log('requesting');

				// Decode asynchronously
				request.onload = function() {
					context.decodeAudioData(request.response, function(buffer) {
			  
						backgroundAudio = context.createBufferSource(); 	// creates a sound source
						backgroundAudio.buffer = buffer;                    // tell the source which sound to play
						backgroundAudio.connect(context.destination);       // connect the source to the context's destination (the speakers)
						backgroundAudio.loop = false;
						//backgroundAudio.start(0);
						
						analyser = context.createAnalyser();
						analyser.fftSize = 512;
						bufferLength = analyser.frequencyBinCount;
						dataArray = new Uint8Array(bufferLength);
						analyser.getByteTimeDomainData(dataArray);
						backgroundAudio.connect(analyser);

						console.log('decoded');

						cb();
			  
					}, function(evt) {
						console.log('failed to load buffer');
						console.log(evt);
					});
				}
				request.send();

			} catch(e) {
				console.log('Web Audio API is not supported in this browser');
				console.log(e);
			}
		}

		document.addEventListener("keydown", keyDownTextField, false);

		function keyDownTextField(e) {
			if (sync_stuff == false) return;
			var keyCode = e.keyCode;
			console.log(keyCode);

			switch(keyCode) {
				case 32: // space
					//init_time = (new Date()).getTime();
					if (skip == false) {
						enterSkip();
					} else {
						initAudio(function(){
								skip = false;
								init_time = (new Date()).getTime() - skip_timer;
								backgroundAudio.start(0, skip_timer/1000);
							});
					}
				break;
			}

		}

		function enterSkip() {
			skip_timer = (new Date()).getTime() - init_time;
			if (backgroundAudio != undefined) backgroundAudio.stop();
			backgroundAudio = undefined;
			skip = true;
		}

		window.addEventListener("wheel", function(e) {
			if (sync_stuff == false) return;
			//var dir = Math.sign(e.deltaY);
			//console.log(dir + ' ' + e.deltaY);
			if (skip == false) {
				enterSkip();
			}
			skip_timer += -e.deltaY;
			if (skip_timer < 0) skip_timer = 0;
		});

    </script>
	
	<div id="starter_menu">
			<div id="info"></div>
			<br />
			<input id="btn" type="button" value="Loading..." disabled onclick="start()"/>
			<br />
			Heart of Molvan√Æa / <a href="http://enoughrecords.scene.org">Enough Records</a>
			<br />
			shadertoy mashup by ps; original music by mons jacet
	</div>
	<canvas id="c"></canvas>
	<span id="timer"></span>
	<span id="recipe1" class="recipe"><img width="100%;" src="gfx/ezgif-4-6c48d04ff789.gif" /></span>
	
	
</body>

</html>
